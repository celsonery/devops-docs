import{_ as a,c as s,o as n,a as e}from"./app-CT-lU83C.js";const i={},l=e(`<h1 id="backup-configs-of-kvm" tabindex="-1"><a class="header-anchor" href="#backup-configs-of-kvm"><span>Backup Configs of KVM</span></a></h1><p>Backing up your KVM configuration is a good practice to ensure you can restore your virtual machines (VMs) in the event of a failure of migration. Below are the main components to beck up and how to do it.</p><hr><h2 id="_1-backup-of-definitions-of-vms-libvirt" tabindex="-1"><a class="header-anchor" href="#_1-backup-of-definitions-of-vms-libvirt"><span>1. Backup of definitions of VMs (libvirt)</span></a></h2><p>If you use the <strong>Libvirt</strong>, the VMs configurations is stored in XML.</p><h3 id="export-configurations" tabindex="-1"><a class="header-anchor" href="#export-configurations"><span>Export configurations</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">virsh</span> list <span class="token parameter variable">--all</span>           <span class="token comment"># See VMs list</span></span>
<span class="line"><span class="token function">virsh</span> dumpxml name-of-vm <span class="token operator">&gt;</span> name-of-vm.xml</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="export-all" tabindex="-1"><a class="header-anchor" href="#export-all"><span>Export all</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token keyword">for</span> <span class="token for-or-select variable">vm</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">virsh</span> list <span class="token parameter variable">--all</span> <span class="token parameter variable">--name</span><span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span></span>
<span class="line">  <span class="token function">virsh</span> dumpxml <span class="token variable">$vm</span> <span class="token operator">&gt;</span> <span class="token string">&quot;<span class="token variable">$vm</span>.xml&quot;</span></span>
<span class="line"><span class="token keyword">done</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Save the all files <code>.xml</code> in the backup folder.</p><hr><h2 id="_2-backup-das-imagens-de-disco" tabindex="-1"><a class="header-anchor" href="#_2-backup-das-imagens-de-disco"><span>2. Backup das imagens de disco</span></a></h2><p>As imagens de disco (normalmente <code>.qcow2</code>, <code>.img</code>, etc.) estão localizadas geralmente em:</p><ul><li><code>/var/lib/libvirt/images/</code></li><li>ou outro diretório configurado.</li></ul><h3 id="copiar-as-imagens" tabindex="-1"><a class="header-anchor" href="#copiar-as-imagens"><span>Copiar as imagens</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">cp</span> /var/lib/libvirt/images/*.qcow2 /backup/dir/</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="backup-incremental-com-rsync" tabindex="-1"><a class="header-anchor" href="#backup-incremental-com-rsync"><span>Backup incremental com rsync</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">rsync</span> <span class="token parameter variable">-avh</span> /var/lib/libvirt/images/ /backup/dir/images/</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><hr><h2 id="_3-backup-de-configuracoes-adicionais" tabindex="-1"><a class="header-anchor" href="#_3-backup-de-configuracoes-adicionais"><span>3. Backup de configurações adicionais</span></a></h2><h3 id="diretorios-importantes" tabindex="-1"><a class="header-anchor" href="#diretorios-importantes"><span>Diretórios importantes</span></a></h3><ul><li><code>/etc/libvirt/</code> – configurações de rede, storage pools, etc.</li><li><code>/etc/qemu/</code> – configurações específicas do QEMU.</li><li><code>/var/lib/libvirt/</code> – arquivos de estado e snapshots.</li></ul><h3 id="compactar-as-configuracoes" tabindex="-1"><a class="header-anchor" href="#compactar-as-configuracoes"><span>Compactar as configurações</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">tar</span> czvf libvirt-configs-backup.tar.gz /etc/libvirt /etc/qemu /var/lib/libvirt</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><hr><h2 id="_4-restauracao" tabindex="-1"><a class="header-anchor" href="#_4-restauracao"><span>4. Restauração</span></a></h2><p>Para restaurar uma VM:</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">virsh</span> define nome-da-vm.xml</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Isso recria a definição da VM a partir do arquivo XML. As imagens de disco precisam estar no mesmo caminho ou ajustadas no XML.</p><hr><h2 id="_5-script-de-backup-automatico" tabindex="-1"><a class="header-anchor" href="#_5-script-de-backup-automatico"><span>5. Script de backup automático</span></a></h2><p>Exemplo de script:</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token assign-left variable">BACKUP_DIR</span><span class="token operator">=</span><span class="token string">&quot;/backup/kvm-<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%F<span class="token variable">)</span></span>&quot;</span></span>
<span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">$BACKUP_DIR</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># Backup das definições</span></span>
<span class="line"><span class="token keyword">for</span> <span class="token for-or-select variable">vm</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">virsh</span> list <span class="token parameter variable">--all</span> <span class="token parameter variable">--name</span><span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span></span>
<span class="line">  <span class="token function">virsh</span> dumpxml <span class="token variable">$vm</span> <span class="token operator">&gt;</span> <span class="token string">&quot;<span class="token variable">$BACKUP_DIR</span>/<span class="token variable">$vm</span>.xml&quot;</span></span>
<span class="line"><span class="token keyword">done</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># Backup das imagens de disco</span></span>
<span class="line"><span class="token function">rsync</span> <span class="token parameter variable">-avh</span> /var/lib/libvirt/images/ <span class="token string">&quot;<span class="token variable">$BACKUP_DIR</span>/images/&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># Backup das configurações</span></span>
<span class="line"><span class="token function">tar</span> czf <span class="token string">&quot;<span class="token variable">$BACKUP_DIR</span>/libvirt-configs.tar.gz&quot;</span> /etc/libvirt /etc/qemu /var/lib/libvirt</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Agende esse script no <code>cron</code> para backups automáticos.</p>`,34),c=[l];function t(r,o){return n(),s("div",null,c)}const d=a(i,[["render",t],["__file","backup-kvm-qemu.html.vue"]]),u=JSON.parse('{"path":"/kvm/backup-kvm-qemu.html","title":"Backup Configs of KVM","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"1. Backup of definitions of VMs (libvirt)","slug":"_1-backup-of-definitions-of-vms-libvirt","link":"#_1-backup-of-definitions-of-vms-libvirt","children":[{"level":3,"title":"Export configurations","slug":"export-configurations","link":"#export-configurations","children":[]},{"level":3,"title":"Export all","slug":"export-all","link":"#export-all","children":[]}]},{"level":2,"title":"2. Backup das imagens de disco","slug":"_2-backup-das-imagens-de-disco","link":"#_2-backup-das-imagens-de-disco","children":[{"level":3,"title":"Copiar as imagens","slug":"copiar-as-imagens","link":"#copiar-as-imagens","children":[]},{"level":3,"title":"Backup incremental com rsync","slug":"backup-incremental-com-rsync","link":"#backup-incremental-com-rsync","children":[]}]},{"level":2,"title":"3. Backup de configurações adicionais","slug":"_3-backup-de-configuracoes-adicionais","link":"#_3-backup-de-configuracoes-adicionais","children":[{"level":3,"title":"Diretórios importantes","slug":"diretorios-importantes","link":"#diretorios-importantes","children":[]},{"level":3,"title":"Compactar as configurações","slug":"compactar-as-configuracoes","link":"#compactar-as-configuracoes","children":[]}]},{"level":2,"title":"4. Restauração","slug":"_4-restauracao","link":"#_4-restauracao","children":[]},{"level":2,"title":"5. Script de backup automático","slug":"_5-script-de-backup-automatico","link":"#_5-script-de-backup-automatico","children":[]}],"git":{"updatedTime":1756395341000,"contributors":[{"name":"Celso Nery","email":"celso.nery@gmail.com","commits":1}]},"filePathRelative":"kvm/backup-kvm-qemu.md"}');export{d as comp,u as data};
