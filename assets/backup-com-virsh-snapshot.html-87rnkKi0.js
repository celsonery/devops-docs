import{_ as a,c as s,o as e,a as n}from"./app-CT-lU83C.js";const i={},l=n(`<h1 id="backup-de-vms-prod" tabindex="-1"><a class="header-anchor" href="#backup-de-vms-prod"><span>Backup de VMs - PROD</span></a></h1><p>Este guia descreve como realizar backups de VMs em produção usando <strong>KVM/QEMU</strong> no <strong>openSUSE Tumbleweed</strong>, sem desligá-las, através de snapshots com <code>virsh</code>.</p><hr><h2 id="pre-requisitos" tabindex="-1"><a class="header-anchor" href="#pre-requisitos"><span>Pré-requisitos</span></a></h2><ul><li>Servidor com <strong>libvirt</strong> e <strong>qemu-kvm</strong> instalados.</li><li><strong>qemu-guest-agent</strong> instalado e rodando dentro de cada VM.</li><li>Espaço suficiente em disco para armazenar os snapshots temporários e o backup.</li><li>As imagens das VMs localizadas em <code>/var/lib/libvirt/images/</code> ou outro diretório conhecido.</li></ul><hr><h2 id="passo-a-passo" tabindex="-1"><a class="header-anchor" href="#passo-a-passo"><span>Passo a passo</span></a></h2><h3 id="_1-criar-snapshot-externo-da-vm" tabindex="-1"><a class="header-anchor" href="#_1-criar-snapshot-externo-da-vm"><span>1. Criar snapshot externo da VM</span></a></h3><p>Este comando cria um snapshot somente de disco, de forma atômica, congelando o sistema de arquivos dentro da VM (se suportado).</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">virsh</span> snapshot-create-as <span class="token parameter variable">--domain</span> NOME_DA_VM snapshot-backup --disk-only <span class="token parameter variable">--atomic</span> --no-metadata <span class="token parameter variable">--quiesce</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>Parâmetros importantes:</strong></p><ul><li><code>--disk-only</code>: Snapshot apenas do disco, sem estado da memória.</li><li><code>--atomic</code>: Garante que todas as alterações sejam aplicadas de forma consistente.</li><li><code>--no-metadata</code>: Não registra o snapshot na configuração permanente da VM.</li><li><code>--quiesce</code>: Congela o sistema de arquivos (requer <code>qemu-guest-agent</code>).</li></ul><hr><h3 id="_2-localizar-o-disco-da-vm" tabindex="-1"><a class="header-anchor" href="#_2-localizar-o-disco-da-vm"><span>2. Localizar o disco da VM</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">virsh</span> domblklist NOME_DA_VM</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Saída exemplo:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">Target   Source</span>
<span class="line">------------------------------------------------</span>
<span class="line">vda      /var/lib/libvirt/images/vm1.qcow2</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="_3-copiar-o-disco-da-vm-para-o-local-de-backup" tabindex="-1"><a class="header-anchor" href="#_3-copiar-o-disco-da-vm-para-o-local-de-backup"><span>3. Copiar o disco da VM para o local de backup</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">rsync</span> <span class="token parameter variable">-avh</span> /var/lib/libvirt/images/vm1.qcow2 /mnt/backup/</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><blockquote><p><strong>Dica:</strong> O <code>rsync</code> permite cópias incrementais, acelerando backups subsequentes.</p></blockquote><hr><h3 id="_4-excluir-snapshot-e-mesclar-alteracoes" tabindex="-1"><a class="header-anchor" href="#_4-excluir-snapshot-e-mesclar-alteracoes"><span>4. Excluir snapshot e mesclar alterações</span></a></h3><p>Após a cópia, é necessário aplicar as alterações feitas durante o snapshot de volta ao disco principal:</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">virsh</span> blockcommit NOME_DA_VM vda <span class="token parameter variable">--active</span> <span class="token parameter variable">--pivot</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><hr><h3 id="_5-confirmar-a-restauracao-do-caminho-original-do-disco" tabindex="-1"><a class="header-anchor" href="#_5-confirmar-a-restauracao-do-caminho-original-do-disco"><span>5. Confirmar a restauração do caminho original do disco</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">virsh</span> domblklist NOME_DA_VM</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><hr><h2 id="automacao-com-script" tabindex="-1"><a class="header-anchor" href="#automacao-com-script"><span>Automação com Script</span></a></h2><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span class="token assign-left variable">VM_NAME</span><span class="token operator">=</span><span class="token variable">$1</span></span>
<span class="line"><span class="token assign-left variable">BACKUP_DIR</span><span class="token operator">=</span><span class="token string">&quot;/mnt/backup/<span class="token variable">$VM_NAME</span>&quot;</span></span>
<span class="line"><span class="token assign-left variable">DATE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%F<span class="token variable">)</span></span></span>
<span class="line"></span>
<span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token string">&quot;<span class="token variable">$BACKUP_DIR</span>/<span class="token variable">$DATE</span>&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token function">virsh</span> snapshot-create-as <span class="token parameter variable">--domain</span> <span class="token string">&quot;<span class="token variable">$VM_NAME</span>&quot;</span> snapshot-backup --disk-only <span class="token parameter variable">--atomic</span> --no-metadata <span class="token parameter variable">--quiesce</span></span>
<span class="line"></span>
<span class="line"><span class="token assign-left variable">DISK_PATH</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">virsh</span> domblklist <span class="token string">&quot;<span class="token variable">$VM_NAME</span>&quot;</span> <span class="token operator">|</span> <span class="token function">grep</span> vda <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">&#39;{print $2}&#39;</span><span class="token variable">)</span></span></span>
<span class="line"><span class="token function">rsync</span> <span class="token parameter variable">-avh</span> <span class="token string">&quot;<span class="token variable">$DISK_PATH</span>&quot;</span> <span class="token string">&quot;<span class="token variable">$BACKUP_DIR</span>/<span class="token variable">$DATE</span>/&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token function">virsh</span> blockcommit <span class="token string">&quot;<span class="token variable">$VM_NAME</span>&quot;</span> vda <span class="token parameter variable">--active</span> <span class="token parameter variable">--pivot</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Uso:</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">./backup_vm.sh NOME_DA_VM</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div>`,33),o=[l];function r(t,c){return e(),s("div",null,o)}const d=a(i,[["render",r],["__file","backup-com-virsh-snapshot.html.vue"]]),m=JSON.parse('{"path":"/br/kvm/backup-com-virsh-snapshot.html","title":"Backup de VMs - PROD","lang":"Português","frontmatter":{},"headers":[{"level":2,"title":"Pré-requisitos","slug":"pre-requisitos","link":"#pre-requisitos","children":[]},{"level":2,"title":"Passo a passo","slug":"passo-a-passo","link":"#passo-a-passo","children":[{"level":3,"title":"1. Criar snapshot externo da VM","slug":"_1-criar-snapshot-externo-da-vm","link":"#_1-criar-snapshot-externo-da-vm","children":[]},{"level":3,"title":"2. Localizar o disco da VM","slug":"_2-localizar-o-disco-da-vm","link":"#_2-localizar-o-disco-da-vm","children":[]},{"level":3,"title":"3. Copiar o disco da VM para o local de backup","slug":"_3-copiar-o-disco-da-vm-para-o-local-de-backup","link":"#_3-copiar-o-disco-da-vm-para-o-local-de-backup","children":[]},{"level":3,"title":"4. Excluir snapshot e mesclar alterações","slug":"_4-excluir-snapshot-e-mesclar-alteracoes","link":"#_4-excluir-snapshot-e-mesclar-alteracoes","children":[]},{"level":3,"title":"5. Confirmar a restauração do caminho original do disco","slug":"_5-confirmar-a-restauracao-do-caminho-original-do-disco","link":"#_5-confirmar-a-restauracao-do-caminho-original-do-disco","children":[]}]},{"level":2,"title":"Automação com Script","slug":"automacao-com-script","link":"#automacao-com-script","children":[]}],"git":{"updatedTime":1756395341000,"contributors":[{"name":"Celso Nery","email":"celso.nery@gmail.com","commits":1}]},"filePathRelative":"br/kvm/backup-com-virsh-snapshot.md"}');export{d as comp,m as data};
